<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      Home - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li  class="active" >
        <a href="index.html">
          
          
            <svg fill="#0095dd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      Treehouse
    </h3>

    <h3>Classes</h3><ul><li id="GraphqQLServer-nav"><a href="GraphqQLServer.html">GraphqQLServer</a></li><li id="default-nav"><a href="module-exception.default.html">default</a></li><li id="AuthorizationException-nav"><a href="module-exception-AuthorizationException.html">AuthorizationException</a></li><li id="Exception-nav"><a href="module-exception-Exception.html">Exception</a></li><li id="InternalException-nav"><a href="module-exception-InternalException.html">InternalException</a></li><li id="InvalidRequestException-nav"><a href="module-exception-InvalidRequestException.html">InvalidRequestException</a></li><li id="ServiceUnavailableException-nav"><a href="module-exception-ServiceUnavailableException.html">ServiceUnavailableException</a></li><li id="Logger-nav"><a href="module-utils_logger-Logger.html">Logger</a><ul class='methods'><li data-type="method" id="Logger-addLogger-nav"><a href="module-utils_logger-Logger.html#.addLogger">addLogger</a></li><li data-type="method" id="Logger-configure-nav"><a href="module-utils_logger-Logger.html#.configure">configure</a></li><li data-type="method" id="Logger-createFallbackLogger-nav"><a href="module-utils_logger-Logger.html#.createFallbackLogger">createFallbackLogger</a></li><li data-type="method" id="Logger-createLogger-nav"><a href="module-utils_logger-Logger.html#.createLogger">createLogger</a></li><li data-type="method" id="Logger-getLogger-nav"><a href="module-utils_logger-Logger.html#.getLogger">getLogger</a></li><li data-type="method" id="Logger-setDefaultLogger-nav"><a href="module-utils_logger-Logger.html#.setDefaultLogger">setDefaultLogger</a></li><li data-type="method" id="Logger-_emit-nav"><a href="module-utils_logger-Logger.html#_emit">_emit</a></li><li data-type="method" id="Logger-serializeTransaction-nav"><a href="module-utils_logger-Logger.html#serializeTransaction">serializeTransaction</a></li></ul></li><li id="Server-nav"><a href="Server.html">Server</a></li></ul><h3>Modules</h3><ul><li id="exception-nav"><a href="module-exception.html">exception</a><ul class='methods'><li data-type="method" id="exception-resolveCode-nav"><a href="module-exception.html#~resolveCode">resolveCode</a></li><li data-type="method" id="exception-resolveMessage-nav"><a href="module-exception.html#~resolveMessage">resolveMessage</a></li><li data-type="method" id="exception-resolveStatus-nav"><a href="module-exception.html#~resolveStatus">resolveStatus</a></li></ul></li><li id="main-nav"><a href="module-main.html">main</a></li><li id="middleware_accessLogger-nav"><a href="module-middleware_accessLogger.html">middleware/accessLogger</a></li><li id="middleware_error-nav"><a href="module-middleware_error.html">middleware/error</a></li><li id="middleware_transaction-nav"><a href="module-middleware_transaction.html">middleware/transaction</a><ul class='methods'><li data-type="method" id="middleware_transaction-default-nav"><a href="module-middleware_transaction.html#.default">default</a></li></ul></li><li id="utils_logger-nav"><a href="module-utils_logger.html">utils/logger</a></li></ul>
  </nav>

  <div id="main">
    

    
      



    

      


  <section class="readme">
    <article>
      <p><a href="https://www.codacy.com/app/gooftroop/treehouse?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=gooftroop/treehouse&amp;utm_campaign=Badge_Grade"><img src="https://api.codacy.com/project/badge/Grade/96c50600236f4d499ee974165aa63850" alt="Codacy Badge"></a>
<a href="https://www.codacy.com/app/gooftroop/treehouse?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=gooftroop/treehouse&amp;utm_campaign=Badge_Coverage"><img src="https://api.codacy.com/project/badge/Coverage/96c50600236f4d499ee974165aa63850" alt="Codacy Badge"></a>
<a href="https://travis-ci.org/gooftroop/treehouse"><img src="https://travis-ci.org/gooftroop/treehouse.svg?branch=master" alt="Build Status"></a></p>
<h1>Treehouse</h1><p>Treehouse is a lightweight <a href="https://koajs.com/">Koa</a>, event-based server that provides common configuration and setup in an Object-Oriented design for both REST and GraphQL servers. The purpose of Treehouse is to help speed up the development of Nodejs services by abstracting out the boilerplate and basic configuration and allow you to focus on your custom middleware or handlers. In addition to providing a core Koa server, Treehouse also exposes other common utilities:</p>
<ul>
<li><a href="https://github.com/trentm/node-bunyan">Bunyan</a> <code>Logger</code></li>
<li>Application-specific Exceptions</li>
<li>GraphQL Server provided by <a href="https://www.apollographql.com/docs/apollo-server/v2/whats-new.html">Apollo Server 2.0</a></li>
</ul>
<p>Additional documentation and API: <a href="https://gooftroop.github.io/treehouse/">here</a>.</p>
<h2>Why Treehouse</h2><p>We get it...building your own server from scratch is fun. So if you like taking various libraries and stitching them together, then this library is probably not for you. However, maybe you like the way this library is setup and is exactly the way you'd do it. Or maybe you're tired of seeing &quot;boilerplates&quot; that set everything up for you, tell you how to code your server, etc. etc., but still don't want to set all the middleware and writing common utilities. If you find yourself saying &quot;that's me!&quot;, then this library is for you. Treehouse aims to find the correct abstraction and empower you to quickly standup a server so you can focus on the application-specific code.</p>
<h2>NOTE</h2><p>This project is currently under development and is subject to change. Please refer to the <a href="">TODOS Section</a> for
the work remaining before version 1.0 is tagged and this enters a table release cycle.</p>
<h2>Installing</h2><pre class="prettyprint source"><code>npm i @harmonizly/treehouse</code></pre><p>You can find the deployment versions <a href="https://github.com/gooftroop/treehouse/releases">here</a>.</p>
<h2>Lifecycle</h2><p>The lifecycle of the server is:</p>
<ol>
<li>Instantiation</li>
<li>Initialized</li>
<li>Start HTTP(S)</li>
<li>Running</li>
<li>Stop</li>
<li>Destroying</li>
<li>Destroyed</li>
</ol>
<p>Every request will run through the following middleware before being evaluated by the router (<a href="https://github.com/alexmingoia/koa-router">koa-router</a>):</p>
<p><br /><p align="center">
  <img src="https://gooftroop.github.io/treehouse/assets/svg/request_processing.svg" />
</p><br /></p>
<p>The middleware <code>transaction</code> is used to tag each request with a unique &quot;transaction&quot; ID using NodeJS <a href="">domain</a>'s to track a request through it's entire time spent in the app.</p>
<p>The <code>access logger</code> middleware uses the <code>bunyan</code> logger to record details about each request prior to entering any custom middleware or handlers. Please refer to the <a href="">Logging Section</a> for more details.</p>
<p>The <code>error</code> middleware wraps all custom middleware and handlers in a <code>try/catch</code> to provide a uniform way to log the error and send the appropriate response. The <code>error</code> middleware ensures that the caught <code>Error</code> is some form of <code>ApiError</code>, so it is recommended that, if you throw a custom <code>Error</code> from any middleware or handlers, you extend <code>ApiError</code>.</p>
<p>Third-party middleware references:</p>
<ul>
<li><a href="https://www.npmjs.com/package/koa-helmet">helmet</a></li>
<li><a href="https://www.npmjs.com/package/koa-cors">cors</a></li>
<li><a href="https://www.npmjs.com/package/koa-bodyparser">bodyparser</a></li>
<li><a href="https://www.npmjs.com/package/koa-compress">compress</a></li>
</ul>
<p><b>Note!</b> When adding your app-specific <code>handlers</code> and <code>middleware</code>, please take some time to understand <code>koa-router</code> and the difference between global middleware and route-specific middleware.</p>
<h2>Details</h2><p>The <code>GraphqQLServer</code> is an added layer on top of the Treehouse <code>Server</code> and sets up <code>apollo-server 2.0</code> from the provided schema object using <code>applyMiddleware</code>. This merely attaches an additional router to the <code>Koa</code> app (from the <code>Server</code>) to handle <code>graphql</code> requests.</p>
<p>A couple notes of interest:</p>
<ul>
<li>The server instance listens to <code>process:exit</code>, which calls <code>destroy</code> to handle process termination.</li>
<li>If <code>process.send</code> exists (i.e. when the process is managed by <code>pm2</code>), the instance sends <code>ready</code> across <code>process.send</code> to notify anyone waiting that the server has beed started.</li>
<li>When the server is destroying, the instance will <code>emit</code> <code>destroy</code> on <code>process</code> to notify anyone watching that the server is going down.</li>
<li>The <code>transactionId</code> is included with every logging output. The <code>transaction</code> context that's included in every logger statement includes information about the user and session, if that data exists. This assumes that an authorized user is attached to the request context as <code>user</code> and the session is attached to the request context as <code>session</code>.</li>
</ul>
<h2>Usage</h2><p>Treehouse requires only a configuration object, but provides flexibility in how you build you app.
The most basic, quick way to get your server running with Treehouse with or without custom middleware and one or more application-specific routers is:</p>
<pre class="prettyprint source"><code>import Server from 'treehouse';

const server = new Server(config)
  .middleware(app => {
    // Attach any middleware here
    // OR
    // Attach any application-specific routers to the app
    // Remember! Order matters when using a connect-based server
  })
  // Provide a callback function to have custom code executed when the server starts
  .onStart(...)
  // Provide a callback function to have custom code executed when the server stops
  .onStop(...);

server.start();</code></pre><p>The GraphQL Server follows the same pattern, but requires a <code>schema</code> object:</p>
<pre class="prettyprint source"><code>import { GraphqQLServer } from 'treehouse';
import { makeExecutableSchema } from 'apollo-server-koa';

const schema = makeExecutableSchema(typedefs, resolvers);

const server = new GraphqQLServer(config, schema)
  .middleware(app => {
    // Attach any middleware here
    // OR
    // Attach any application-specific routers to the app
    // Remember! Order matters when using a connect-based server
  })
  // Provide a callback function to have custom code executed when the server starts
  .onStart(...)
  // Provide a callback function to have custom code executed when the server stops
  .onStop(...);

server.start();</code></pre><p>Treehouse can also be extended to provide more complex implementations:</p>
<pre class="prettyprint source"><code>import Server from 'treehouse';

class MyServer extends Server {

  constructor() {
    super(config);
  }

  initialize() {
    // Override initialize to either override the default middleware or to have
    // more flexibility in attaching middleware you want to use.
    // If you wish to keep the default middleware in addition to the ones you
    // add, don't forget to call `super.initialize();`!
  }

  start() {
    // Override start to change the startup behavior.
    // Use `super.start();` if you want to augment start before or after the
    // server starts up
  }

  stop() {
    // Override stop to change the startup behavior.
    // Use `super.stop();` if you want to augment stop before or after the
    // server stops accepting connections
  }
}</code></pre><p>The <code>GraphQL Server</code> can also be overridden this way. The only difference is that the constructor must be provided the <code>schema</code> object.</p>
<h3>Logging</h3><h3>Configuration</h3><p>It is highly recommended that you use <a href="https://github.com/lorenwest/node-config/wiki">node-config</a> as your configuration library and to pass the resulting configuration object to Treehouse.
The following an example configuration showing all the available options:</p>
<pre class="prettyprint source"><code>{
  bodyparser: { ... }, // configuration for koa-bodyparser
  cors: { ... }, // configuration for koa-cors
  compress: {},  // configuration for koa-compress
  // The following configuration option is only needed if you're using the GraphQL Server
  graphql: {
    gui: process.env.NODE_ENV === 'development',
    introspection: true,
    url: &quot;/graphql&quot;,
  },
  // Treehouse logger configuration
  // Optional
  loggers: {
    handlers: {
      access: {
        name: 'access',
        level: 'info',
      },
    },
    streams: {
      // Under construction
    },
  },
  server: {
    hostname: '0.0.0.0',
    port: 3000,
    secure: false,
    ssl: {
      key: '&lt;file path>',
      cert: '&lt;file path>'
    },
  },
}</code></pre><h2>Building</h2><p>We use <code>Make</code> to run various build tasks. See <code>Makefile</code> for details on the build process.</p>
<p>To build a deployment (production) <code>dist</code>, run <code>make</code>.</p>
<p>To build development <code>dist</code>, run <code>make dev</code>.</p>
<h2>Contributing</h2><p>Ensure that you are pushing to a branch off of <code>master</code> and not to <code>master</code> directly.
Please follow standard git flow practices for merging branches with a PR.</p>
<p>The <code>dist</code> bundle is created using <a href="https://webpack.js.org/">webpack</a> (located under the <code>build/</code> directory). To build in the <code>production</code> mode, ensure that the <code>NODE_ENV</code> environment variable is set to <code>production</code>.</p>
<p>Distribution is currently hosted through Github, so the binary is currently tracked.
To build and &quot;deploy&quot;, run <code>make</code> at the root project directory and commit the resulting <code>dist</code> bundle.</p>
<h3>TODOs</h3><ul>
<li>[ ] Complete tests (tested manually, but need full suite)</li>
<li>[ ] Finish setting up travis for complete testing, build, and deploy</li>
<li>[ ] Support custom streams for bunyan in log configuration</li>
<li>[x] Apollo Server V2</li>
<li>[ ] Migrate to Typescript</li>
<li>[x] Improve Server interface around stop, start, middleware, &amp; routers</li>
<li>[ ] Update documentation with updates interfaces</li>
</ul>
<h2>Testing</h2><p>Under construction.</p>
<p>All testing is done using <a href="">jest</a>.</p>
<p>To run tests, use <code>npm test</code>. You can provide additional arguments to <code>Mocha</code> by running <code>npm test -- &lt;opts&gt;</code>.</p>
    </article>
  </section>


    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  
  
</body>
</html>
